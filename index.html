<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>REFORMER åˆç´š</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500&display=swap');

  :root {
    --bg:#0e0e0f; --surface:#1a1a1c; --surface2:#232325;
    --accent:#c8f0d4; --accent-dim:rgba(200,240,212,0.12); --accent-glow:rgba(200,240,212,0.25);
    --text:#e8e8ea; --text-dim:#7a7a80;
    --red:#f0a0a0; --red-dim:rgba(240,160,160,0.15);
    --gold:#f0d48a; --gold-dim:rgba(240,212,138,0.12);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family:'DM Sans',sans-serif;
    background:var(--bg); color:var(--text);
    min-height:100vh; overflow-x:hidden;
    -webkit-font-smoothing:antialiased;
  }

  /* â”€â”€â”€ PAGES â”€â”€â”€ */
  .page { display:none; min-height:100vh; }
  .page.active { display:block; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOME PAGE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .home-header { text-align:center; padding:56px 20px 0; }
  .home-header h1 {
    font-family:'Playfair Display',serif;
    font-size:clamp(1.7rem,5vw,2.2rem);
    font-weight:700; letter-spacing:0.02em;
    color:var(--accent); margin-bottom:6px;
  }
  .home-header .subtitle {
    color:var(--text-dim); font-size:0.83rem;
    font-weight:300; letter-spacing:0.04em;
  }

  /* nav links row */
  .home-nav { display:flex; justify-content:center; gap:20px; padding:18px 0 0; }
  .nav-link {
    display:inline-flex; align-items:center; gap:5px;
    color:var(--text-dim); font-size:.76rem;
    background:none; border:none; cursor:pointer;
    font-family:'DM Sans',sans-serif;
    letter-spacing:0.05em; text-transform:uppercase;
    transition:color .2s; padding:4px 0;
  }
  .nav-link:hover { color:var(--accent); }
  .nav-link svg { width:13px; height:13px; opacity:.55; }

  /* start content */
  .start-content { text-align:center; padding:52px 24px 0; }
  .start-content h2 { font-family:'Playfair Display',serif; font-size:1.35rem; color:var(--accent); margin-bottom:10px; }
  .start-content p { color:var(--text-dim); font-size:.83rem; line-height:1.7; max-width:320px; margin:0 auto 32px; }
  .start-btn {
    display:block; width:100%; max-width:280px; margin:0 auto 10px;
    padding:14px 20px; border-radius:14px;
    background:var(--accent); color:var(--bg); border:none;
    font-family:'DM Sans',sans-serif; font-size:.9rem; font-weight:500;
    cursor:pointer; transition:transform .15s, box-shadow .2s;
    box-shadow:0 0 16px var(--accent-glow);
  }
  .start-btn:active { transform:scale(.96); }
  .start-btn.secondary {
    background:transparent; border:1px solid var(--surface2);
    color:var(--text-dim); box-shadow:none; font-size:.83rem;
  }
  .start-btn.secondary:active { transform:scale(.96); }

  /* mid pick */
  .mid-pick-wrap { padding:0 20px; max-width:420px; margin:0 auto; }
  .mid-pick-head { text-align:center; padding:40px 0 8px; }
  .mid-pick-head h2 { font-family:'Playfair Display',serif; font-size:1.2rem; color:var(--accent); margin-bottom:6px; }
  .mid-pick-head p { color:var(--text-dim); font-size:.8rem; }
  .mid-pick-list { max-height:55vh; overflow-y:auto; padding:12px 0; -webkit-overflow-scrolling:touch; }
  .mid-pick-item {
    display:flex; align-items:center; gap:12px;
    padding:13px 14px; border-radius:12px;
    background:var(--surface); border:1px solid var(--surface2);
    margin-bottom:6px; cursor:pointer; transition:border-color .2s;
    -webkit-tap-highlight-color:transparent;
  }
  .mid-pick-item:active { border-color:var(--accent); }
  .mid-pick-item .mp-num { font-size:.7rem; color:var(--text-dim); width:20px; text-align:right; flex-shrink:0; }
  .mid-pick-item .mp-name { font-size:.84rem; color:var(--text); }
  .mid-pick-item .mp-name-en { font-size:.68rem; color:var(--text-dim); margin-top:1px; }
  .mid-pick-back {
    display:block; width:100%; text-align:center; margin-top:12px;
    background:none; border:none; color:var(--text-dim); font-size:.78rem;
    cursor:pointer; font-family:'DM Sans',sans-serif; padding:10px 0;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EXAM PAGE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .exam-top {
    position:sticky; top:0; z-index:10;
    background:var(--bg); border-bottom:1px solid var(--surface2);
    padding:12px 20px; display:flex; align-items:center; justify-content:space-between;
  }
  .exam-progress-wrap { flex:1; max-width:200px; }
  .exam-progress-label { font-size:.65rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:.06em; margin-bottom:4px; }
  .exam-progress-bar { height:3px; background:var(--surface2); border-radius:2px; overflow:hidden; }
  .exam-progress-fill { height:100%; background:var(--accent); border-radius:2px; transition:width .5s cubic-bezier(.4,0,.2,1); box-shadow:0 0 6px var(--accent-glow); }
  .exam-timer {
    display:flex; align-items:center; gap:6px;
    background:var(--surface); border:1px solid var(--surface2);
    border-radius:16px; padding:5px 12px;
  }
  .exam-timer-icon { font-size:.8rem; opacity:.5; }
  .exam-timer-val { font-size:.8rem; font-weight:500; color:var(--accent); letter-spacing:.06em; font-variant-numeric:tabular-nums; }

  /* chain */
  .chain {
    max-width:480px; margin:0 auto;
    padding:16px 20px 100px; position:relative;
  }
  .chain::before {
    content:''; position:absolute;
    left:50%; top:0; bottom:0; width:2px;
    background:linear-gradient(to bottom,transparent,var(--surface2) 50px,var(--surface2));
    transform:translateX(-50%); z-index:0;
  }

  /* â”€â”€â”€ CARD â”€â”€â”€ */
  .card {
    position:relative; z-index:1;
    background:var(--surface); border:1px solid var(--surface2);
    border-radius:16px; overflow:hidden;
    animation:cardIn .35s cubic-bezier(.4,0,.2,1) both;
  }
  @keyframes cardIn { from{opacity:0;transform:translateY(16px) scale(.97)} to{opacity:1;transform:translateY(0) scale(1)} }
  .card-header { display:flex; align-items:center; gap:12px; padding:16px 16px 14px; }
  .battery { width:36px; height:20px; position:relative; flex-shrink:0; }
  .battery-body { width:32px; height:20px; border:2px solid var(--accent); border-radius:5px; overflow:hidden; position:relative; }
  .battery-fill { position:absolute; bottom:0; left:0; right:0; background:var(--accent); transition:height .4s ease; }
  .battery-nub { position:absolute; right:-4px; top:50%; transform:translateY(-50%); width:3.5px; height:9px; background:var(--accent); border-radius:0 2px 2px 0; }
  .card-title { flex:1; min-width:0; }
  .card-title .label { font-size:.64rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:.08em; margin-bottom:2px; }
  .card-title .name { font-family:'Playfair Display',serif; font-size:.95rem; font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .card-title .name-en { font-size:.64rem; color:var(--text-dim); margin-top:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .card-status { font-size:.6rem; padding:3px 8px; border-radius:20px; font-weight:500; letter-spacing:.05em; text-transform:uppercase; white-space:nowrap; flex-shrink:0; }
  .card-status.correct { background:var(--accent-dim); color:var(--accent); }
  .card-status.pending { background:var(--gold-dim); color:var(--gold); animation:pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

  /* sub items */
  .sub-items { border-top:1px solid var(--surface2); }
  .sub-item { display:flex; align-items:center; gap:10px; padding:9px 16px 9px 30px; border-bottom:1px solid var(--surface2); animation:cardIn .3s ease both; }
  .sub-item:last-child { border-bottom:none; }
  .sub-item .dot { width:6px; height:6px; border-radius:50%; background:var(--accent); box-shadow:0 0 5px var(--accent-glow); flex-shrink:0; }
  .sub-item .sub-name { font-size:.78rem; color:var(--text); }
  .sub-item .sub-name-en { font-size:.64rem; color:var(--text-dim); margin-left:5px; }

  /* connector */
  .connector { display:flex; justify-content:center; padding:8px 0; position:relative; z-index:1; }
  .connector-line { width:2px; height:18px; background:var(--surface2); }

  /* â”€â”€â”€ çµæŸæ¸¬é©— å›ºå®šåº•åˆ— â”€â”€â”€ */
  .end-bar {
    position:fixed; bottom:0; left:0; right:0; z-index:50;
    padding:10px 20px 28px;
    background:var(--bg);
    border-top:1px solid var(--surface2);
  }
  .end-btn {
    display:flex; align-items:center; justify-content:center; gap:7px;
    width:100%; max-width:480px; margin:0 auto;
    padding:13px 20px; border-radius:12px;
    background:var(--red); border:none;
    color:var(--bg); font-family:'DM Sans',sans-serif;
    font-size:.84rem; font-weight:500; cursor:pointer;
    -webkit-tap-highlight-color:transparent;
    transition:opacity .2s;
  }
  .end-btn:active { opacity:.7; }
  .end-btn svg { width:14px; height:14px; opacity:.7; }

  /* â”€â”€â”€ OVERLAY (quiz) â”€â”€â”€ */
  .overlay {
    position:fixed; top:0; left:0; right:0; bottom:71px;
    background:rgba(0,0,0,.65);
    z-index:100; display:flex; align-items:flex-end; justify-content:center;
    opacity:0; pointer-events:none; transition:opacity .3s;
  }
  .overlay.open { opacity:1; pointer-events:auto; }

  /* æ”¶åˆç‹€æ…‹ï¼šé®å…‰å±¤é€æ˜ + pointer-eventsç©¿é€ï¼Œpanelç¸®ç‚ºé ‚éƒ¨å°æ¢ä½†è‡ªå·±å¯é» */
  .overlay.collapsed {
    opacity:1; pointer-events:none;
    background:transparent;
  }
  .overlay.collapsed .quiz-panel {
    transform:translateY(calc(100% - 34px));
    pointer-events:auto;
    border-radius:16px 16px 0 0;
  }

  .quiz-panel {
    background:var(--surface); border-radius:20px 20px 0 0;
    width:100%; max-width:480px;
    padding:10px 20px 18px;
    transform:translateY(100%); transition:transform .38s cubic-bezier(.4,0,.2,1);
    max-height:calc(100vh - 71px - 20px); overflow-y:auto; -webkit-overflow-scrolling:touch;
  }
  .overlay.open .quiz-panel { transform:translateY(0); }

  /* æ”¶åˆéµ */
  .quiz-collapse-btn {
    display:flex; align-items:center; justify-content:center; gap:6px;
    width:100%; height:24px; margin-bottom:6px;
    background:none; border:none; cursor:pointer;
    -webkit-tap-highlight-color:transparent;
  }
  .collapse-handle { width:32px; height:3px; background:var(--surface2); border-radius:2px; }
  .collapse-arrow {
    width:0; height:0;
    border-left:4px solid transparent; border-right:4px solid transparent;
    border-top:4px solid var(--text-dim);
    transition:transform .22s;
  }
  .overlay.collapsed .collapse-arrow { transform:rotate(180deg); }

  .quiz-step-label { font-size:.64rem; text-transform:uppercase; letter-spacing:.1em; color:var(--gold); margin-bottom:5px; }
  .quiz-step-label:empty { display:none; margin:0; }
  .quiz-question { font-family:'Playfair Display',serif; font-size:1.05rem; color:var(--text); margin-bottom:12px; line-height:1.4; }

  /* options â€” ä¸­è‹±ä¸€è¡Œ */
  .options { display:flex; flex-direction:column; gap:5px; }
  .option {
    display:flex; align-items:center; gap:10px;
    background:var(--surface2); border:1px solid transparent;
    border-radius:10px; padding:8px 12px;
    cursor:pointer; transition:border-color .18s, background .18s;
    user-select:none; -webkit-user-select:none;
    -webkit-tap-highlight-color:transparent;
  }
  .option:active { border-color:rgba(200,240,212,0.3); }
  .option .opt-key {
    width:24px; height:24px; border-radius:6px;
    background:var(--surface); border:1px solid var(--surface2);
    display:flex; align-items:center; justify-content:center;
    font-size:.7rem; color:var(--text-dim); font-weight:500; flex-shrink:0;
  }
  /* ä¸­è‹±ä¸€è¡Œå®¹å™¨ */
  .option .opt-label { font-size:.82rem; color:var(--text); line-height:1.35; flex:1; min-width:0; }
  .option .opt-label .opt-en { color:var(--text-dim); font-size:.68rem; margin-left:4px; white-space:nowrap; }

  .option.correct-pick { border-color:var(--accent); background:var(--accent-dim); }
  .option.correct-pick .opt-key { background:var(--accent); color:var(--bg); border-color:transparent; }
  .option.wrong-pick { border-color:var(--red); background:var(--red-dim); }
  .option.wrong-pick .opt-key { background:var(--red); color:var(--bg); border-color:transparent; }
  .option.disabled { pointer-events:none; opacity:.4; }
  .option.wrong-pick.disabled { opacity:.6; }

  /* feedback */
  .feedback { margin-top:8px; font-size:.76rem; color:var(--text-dim); min-height:18px; display:flex; align-items:center; gap:6px; opacity:0; transition:opacity .2s; }
  .feedback.show { opacity:1; }


  /* â”€â”€â”€ FINISH â”€â”€â”€ */
  .finish-banner { text-align:center; padding:80px 24px; }
  .finish-banner h2 { font-family:'Playfair Display',serif; font-size:1.7rem; color:var(--gold); margin-bottom:6px; }
  .finish-banner .finish-time { color:var(--accent); font-size:.88rem; margin-bottom:8px; font-weight:500; }
  .finish-banner .finish-mode { color:var(--text-dim); font-size:.78rem; margin-bottom:24px; }
  .finish-banner p { color:var(--text-dim); font-size:.84rem; margin-bottom:20px; }
  .restart-btn {
    display:block; width:100%; max-width:240px; margin:0 auto;
    padding:13px; border-radius:12px;
    background:var(--accent); color:var(--bg); border:none;
    font-family:'DM Sans',sans-serif; font-size:.85rem; font-weight:500;
    cursor:pointer; transition:opacity .2s;
  }
  .restart-btn:active { opacity:.7; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HISTORY PAGE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .history-page { padding:0 20px 60px; max-width:480px; margin:0 auto; }
  .history-header { display:flex; align-items:center; justify-content:space-between; padding:48px 0 20px; }
  .history-header h2 { font-family:'Playfair Display',serif; font-size:1.2rem; color:var(--accent); }
  .back-btn { background:none; border:none; color:var(--text-dim); font-size:.76rem; cursor:pointer; font-family:'DM Sans',sans-serif; display:flex; align-items:center; gap:4px; padding:8px 0; }
  .back-btn:active { color:var(--text); }

  .history-section-title { font-size:.66rem; text-transform:uppercase; letter-spacing:.1em; color:var(--text-dim); margin:22px 0 10px; }

  /* record item â€” 3 badges */
  .record-item {
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    background:var(--surface); border:1px solid var(--surface2);
    border-radius:10px; padding:12px 14px; margin-bottom:6px;
  }
  .record-date { font-size:.8rem; color:var(--text); font-variant-numeric:tabular-nums; flex-shrink:0; }
  .record-badges { display:flex; gap:5px; flex-wrap:wrap; margin-left:auto; }
  .record-badge {
    font-size:.6rem; padding:3px 7px; border-radius:10px;
    font-weight:500; letter-spacing:.03em; white-space:nowrap;
  }
  .record-badge.full { background:var(--accent-dim); color:var(--accent); }
  .record-badge.partial { background:var(--gold-dim); color:var(--gold); }
  .record-badge.complete { background:var(--accent-dim); color:var(--accent); }
  .record-badge.interrupted { background:var(--red-dim); color:var(--red); }

  /* analysis */
  .analysis-item {
    display:flex; align-items:center; gap:10px;
    background:var(--surface); border:1px solid var(--accent);
    border-radius:10px; padding:11px 12px; margin-bottom:4px;
  }
  .a-battery { width:26px; height:15px; position:relative; flex-shrink:0; }
  .a-bat-body { width:23px; height:15px; border:1.5px solid var(--accent); border-radius:4px; overflow:hidden; position:relative; }
  .a-bat-fill { position:absolute; bottom:0; left:0; right:0; background:var(--accent); }
  .a-bat-nub { position:absolute; right:-3px; top:50%; transform:translateY(-50%); width:2.5px; height:6px; background:var(--accent); border-radius:0 2px 2px 0; }
  .a-info { flex:1; min-width:0; }
  .a-name { font-size:.78rem; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .a-name-en { font-size:.64rem; color:var(--text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .a-err { font-size:.7rem; font-weight:500; white-space:nowrap; flex-shrink:0; }
  .a-err.zero { color:var(--accent); }
  .a-err.low { color:var(--gold); }
  .a-err.high { color:var(--red); }

  .analysis-sub { margin-left:18px; }
  .analysis-sub .analysis-item { padding:7px 12px; border-radius:8px; border-color:var(--surface2); }

  .clear-btn {
    display:block; width:100%; margin-top:28px;
    padding:12px; border-radius:10px;
    background:transparent; border:1px solid var(--red-dim);
    color:var(--red); font-family:'DM Sans',sans-serif;
    font-size:.78rem; cursor:pointer; transition:background .2s;
  }
  .clear-btn:active { background:var(--red-dim); }

  .more-btn {
    display:block; width:100%; margin-top:4px;
    padding:10px; border-radius:8px;
    background:transparent; border:1px solid var(--surface2);
    color:var(--text-dim); font-family:'DM Sans',sans-serif;
    font-size:.76rem; cursor:pointer; transition:border-color .2s, color .2s;
    -webkit-tap-highlight-color:transparent;
  }
  .more-btn:active { border-color:var(--accent); color:var(--accent); }

  .empty-msg { color:var(--text-dim); font-size:.8rem; text-align:center; padding:36px 0; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: HOME
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="pageHome">
  <div class="home-header">
    <h1>REFORMER-åˆç´š</h1>
    <div class="subtitle">è€ƒé©—ä½ çš„è¨˜æ†¶åŠ›!</div>
  </div>
  <div class="home-nav">
    <button class="nav-link" onclick="goHistory()">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><polyline points="8,4 8,8 10.5,10"/></svg>
      æ­·å²ç´€éŒ„
    </button>
  </div>

  <!-- start buttons -->
  <div id="startScreen">
    <div class="start-content">
      <h2>æº–å‚™é–‹å§‹ï¼Ÿ</h2>
      <p>ä¾åºèƒŒå‡ºæ‰€æœ‰çš®æ‹‰ææ–¯å‹•ä½œã€‚å…ˆé¸æ­£ç¢ºçš„å‹•ä½œåç¨±ï¼Œå†åˆ¤æ–·æ˜¯ç³»åˆ—å‹•ä½œé‚„æ˜¯å–®ä¸€å‹•ä½œã€‚ç³»åˆ—å‹•ä½œé‚„è¦ä¾åºé¸å‡ºæ¯å€‹æ¬¡é …ç›®ã€‚</p>
      <button class="start-btn" onclick="chooseStart('full')">å¾é ­é–‹å§‹</button>
      <button class="start-btn secondary" onclick="chooseStart('mid')">å¾ä¸­é–“é–‹å§‹</button>
    </div>
  </div>

  <!-- mid pick list -->
  <div id="midPickScreen" style="display:none">
    <div class="mid-pick-wrap">
      <div class="mid-pick-head">
        <h2>é¸æ“‡é–‹å§‹ä½ç½®</h2>
        <p>å¾å“ªå€‹å‹•ä½œé–‹å§‹ç·´ç¿’ï¼Ÿ</p>
      </div>
      <div class="mid-pick-list" id="midPickList"></div>
      <button class="mid-pick-back" onclick="backToStart()">â† è¿”å›</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: EXAM
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="pageExam">
  <!-- sticky top bar: progress + timer -->
  <div class="exam-top">
    <div class="exam-progress-wrap">
      <div class="exam-progress-label"><span id="progressText">0 / 29</span></div>
      <div class="exam-progress-bar"><div class="exam-progress-fill" id="progressFill" style="width:0%"></div></div>
    </div>
    <div class="exam-timer">
      <span class="exam-timer-icon">â±</span>
      <span class="exam-timer-val" id="timerVal">00:00</span>
    </div>
  </div>

  <!-- chain -->
  <div class="chain" id="chain"></div>

  <!-- finish banner (shown inside exam page) -->
  <div class="finish-banner" id="finishBanner" style="display:none">
    <h2 id="finishTitle">ğŸ‰ å®Œæˆï¼</h2>
    <div class="finish-time" id="finishTime"></div>
    <div class="finish-mode" id="finishMode"></div>
    <button class="restart-btn" onclick="goHome()">å›åˆ°é¦–é </button>
  </div>

  <!-- fixed bottom: çµæŸæ¸¬é©— -->
  <div class="end-bar" id="endBar">
    <button class="end-btn" onclick="endExam()">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="4" height="10" rx="1"/><rect x="9" y="3" width="4" height="10" rx="1"/></svg>
      çµæŸæ¸¬é©—
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: HISTORY
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="pageHistory">
  <div class="history-page">
    <div class="history-header">
      <h2>æ­·å²ç´€éŒ„</h2>
      <button class="back-btn" onclick="goHome()">â† è¿”å›</button>
    </div>
    <div class="history-section-title">æ¸¬é©—è¨˜éŒ„</div>
    <div id="recordsList"></div>
    <div class="history-section-title">æ•¸æ“šåˆ†æ</div>
    <div id="analysisList"></div>
    <button class="clear-btn" onclick="clearHistory()">æ¸…ç©ºæ­·å²ç´€éŒ„</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     QUIZ OVERLAY
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="overlay">
  <div class="quiz-panel">
    <button class="quiz-collapse-btn" onclick="toggleCollapse()">
      <span class="collapse-handle"></span>
      <span class="collapse-arrow"></span>
    </button>
    <div class="quiz-step-label" id="quizStepLabel"></div>
    <div class="quiz-question" id="quizQuestion"></div>
    <div class="options" id="quizOptions"></div>
    <div class="feedback" id="quizFeedback"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RAW=[
  {type:"series",main:"è…³éƒ¨ç·´ç¿’",mainEn:"FOOT WORK",subs:[{zh:"è…³æŒåˆ†é–‹é›™è¸µä½µæ”",en:"TOES APART HEELS TOGETHER"},{zh:"è…³è¶¾æŠ“æ¡¿",en:"WRAP TOES ON BAR"},{zh:"é›™è¸µæŠµåœ¨è…³è¸æ¡¿ä¸Š",en:"HEELS ON BAR"},{zh:"è…³å°–æ‚èµ·",en:"HIGH HALF TOE"},{zh:"è½è¸µèˆ‡æè¸µ",en:"LOWER & LIFT"}]},
  {type:"series",main:"ç¬¬äºŒç¨®å§¿å‹¢",mainEn:"SECOND POSITION",subs:[{zh:"å¹³è¡Œ",en:"PARALLEL"},{zh:"å¤–æ—‹",en:"LATERALLY ROTATED"},{zh:"å…§æ—‹",en:"MEDIALLY ROTATED"}]},
  {type:"series",main:"å–®è…¿ç·´ç¿’",mainEn:"SINGLE LEG",subs:[{zh:"å–®è…¿å½æ›²",en:"ONE LEG BENT"},{zh:"è…³è¸è»Šå¼å‹•ä½œ",en:"BICYCLE"},{zh:"å–®è¸µç·´ç¿’",en:"SINGLE HEEL"}]},
  {type:"single",main:"ç™¾æ¬¡æ‹æ“Š",mainEn:"HUNDRED",subs:[]},
  {type:"series",main:"å±ˆä¼¸ç·´ç¿’",mainEn:"BEND & STRETCH",subs:[{zh:"å¹³è¡Œ",en:"PARALLEL"},{zh:"å¤–æ—‹",en:"LATERALLY ROTATED"},{zh:"å…§æ—‹",en:"MEDIALLY ROTATED"}]},
  {type:"series",main:"æŠ¬è…¿èˆ‡æ”¾è…¿",mainEn:"LIFT & LOWER",subs:[{zh:"å¹³è¡Œ",en:"PARALLEL"},{zh:"å¤–æ—‹",en:"LATERALLY ROTATED"}]},
  {type:"single",main:"ä¼¸å±•å…§æ”¶è‚Œ",mainEn:"ADDUCTOR STRETCH",subs:[]},
  {type:"single",main:"è„Šæ¤æ²æ›²æº–å‚™å‹•ä½œ",mainEn:"SHORT SPINE PREP",subs:[]},
  {type:"single",main:"è„Šæ¤æ²æ›²",mainEn:"SHORT SPINE",subs:[]},
  {type:"series",main:"ä¸­èƒŒéƒ¨ç³»åˆ—å‹•ä½œ",mainEn:"MIDBACK SERIES",subs:[{zh:"ä¸‹å£“è‚±ä¸‰é ­è‚Œ",en:"TRICEPS PRESS"},{zh:"é›™è‡‚ä¼¸ç›´ä¸‹å£“",en:"STRAIGHT DOWN"},{zh:"å››åäº”åº¦",en:"FORTY-FIVE DEGREES"},{zh:"å´å±•",en:"SIDE"},{zh:"ç•«åœˆ",en:"CIRCLES"}]},
  {type:"series",main:"å¾Œåˆ’æº–å‚™å‹•ä½œ",mainEn:"BACK ROWING PREPS",subs:[{zh:"åˆ’èˆ¹å‹•ä½œ",en:"PLOW"},{zh:"åˆ†é–‹é›™è‚˜",en:"OPEN ELBOWS"},{zh:"é£›ç¿”å‹•ä½œ",en:"AIRPLANE"},{zh:"äºŒé ­è‚Œæ²æ›²",en:"BICEPS CURLS"},{zh:"è‚±ä¸‰é ­è‚Œ",en:"TRICEPS"},{zh:"å‘å¾Œæ²å‹•",en:"ROLL-DOWN"},{zh:"å‘å¾Œæ²å‹•-äºŒé ­è‚Œæ²æ›²",en:"ROLL-DOWN WITH BICEPS CURLS"},{zh:"å´æ—‹å¾Œæ²",en:"ROLL-DOWN WITH OBLIQUES"}]},
  {type:"series",main:"å´åæ‰‹è‡‚æº–å‚™å‹•ä½œ",mainEn:"SIDE ARM PREPS SITTING",subs:[{zh:"å…§æ—‹",en:"INTERNAL ROTATION"},{zh:"å¤–æ—‹",en:"EXTERNAL ROTATION"},{zh:"å…§æ”¶",en:"ADDUCTION"},{zh:"å¤–å±•",en:"ABDUCTION"}]},
  {type:"single",main:"å´è½‰åå§¿",mainEn:"SIDE TWIST SITTING",subs:[]},
  {type:"series",main:"å‰åˆ’æº–å‚™å‹•ä½œ",mainEn:"FRONT ROWING PREPS",subs:[{zh:"å‘å‰ä¼¸ç›´",en:"STRAIGHT FORWARD"},{zh:"ç¬¬äºŒç¨®å§¿å‹¢",en:"SECOND POSITION"},{zh:"é›™æ‰‹ä¸Šæ‰˜",en:"OFFERING"}]},
  {type:"series",main:"è…¹éƒ¨æŒ‰æ‘©",mainEn:"STOMACH MASSAGE",subs:[{zh:"æº–å‚™å‹•ä½œ",en:"PREP"},{zh:"å¼“èƒŒ",en:"ROUND BACK"},{zh:"ç›´èƒŒ",en:"STRAIGHT BACK"}]},
  {type:"series",main:"é›™è‡‚æ‹‰å‹•æ‹‰ç’°(ç›’å­è±æ”¾)",mainEn:"ARMS PULLING STRAPS, LONG BOX",subs:[{zh:"åˆ’èˆ¹å‹•ä½œ",en:"PLOW"},{zh:"é£›ç¿”å‹•ä½œ",en:"AIRPLANE"},{zh:"è‚±ä¸‰é ­è‚Œ",en:"TRICEPS"}]},
  {type:"single",main:"å¼“èƒŒ(ç›’å­æ©«æ”¾)",mainEn:"ROUND BACK, SHORT BOX",subs:[]},
  {type:"single",main:"ç›´èƒŒ(ç›’å­æ©«æ”¾)",mainEn:"STRAIGHT BACK, SHORT BOX",subs:[]},
  {type:"single",main:"æ‰­è½‰(ç›’å­æ©«æ”¾)",mainEn:"TWIST, SHORT BOX",subs:[]},
  {type:"single",main:"æ¨¹å§¿(ç›’å­æ©«æ”¾)",mainEn:"TREE, SHORT BOX",subs:[]},
  {type:"series",main:"å¤§è±¡å§¿",mainEn:"ELEPHANT",subs:[{zh:"å¼“èƒŒ",en:"ROUND BACK"},{zh:"ç›´èƒŒ",en:"STRAIGHT BACK"}]},
  {type:"single",main:"ç¾äººé­šå§¿",mainEn:"MERMAID",subs:[]},
  {type:"series",main:"é›™è…¿ç•«å¼§",mainEn:"LEG CIRCLES",subs:[{zh:"å¹³è¡Œ",en:"PARALLEL"},{zh:"å¤–æ—‹",en:"LATERALLY ROTATED"},{zh:"å…§æ—‹",en:"MEDIALLY ROTATED"}]},
  {type:"series",main:"è†éƒ¨ä¼¸å±•",mainEn:"KNEE STRETCHES",subs:[{zh:"æº–å‚™å‹•ä½œ",en:"PREP"},{zh:"å¼“èƒŒ",en:"ROUND BACK"},{zh:"ç›´èƒŒ",en:"STRAIGHT BACK"}]},
  {type:"single",main:"è·‘æ­¥é‹å‹•",mainEn:"RUNNING",subs:[]},
  {type:"single",main:"é«–éƒ¨ä¸ŠæŠ¬",mainEn:"HIP LIFT",subs:[]},
  {type:"single",main:"é«–éƒ¨èµ·ä¼",mainEn:"HIP ROLLS",subs:[]},
  {type:"single",main:"å–®å´å¤§è…¿ä¼¸å±•",mainEn:"SINGLE THIGH STRETCH",subs:[]},
  {type:"series",main:"å´åŠˆå‰",mainEn:"SIDE SPLITS",subs:[{zh:"å¤–å±•",en:"ABDUCTION"},{zh:"å…§æ”¶",en:"ADDUCTION"}]}
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state={
  currentIdx:0, phase:null, subIdx:0,
  completedMains:[], startIdx:0,
  mode:null,          // 'full'|'mid'
  finished:false,     // true = å®Œæˆåˆ°æœ€å¾Œ; false = ä¸­æ–·
  timerSec:0, timerInterval:null,
  errors:{}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffle(a){ a=[...a]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

function updateProgress(){
  const total=RAW.length-state.startIdx;
  const done=state.completedMains.length;
  document.getElementById('progressText').textContent=done+' / '+total;
  document.getElementById('progressFill').style.width=(done/total*100)+'%';
}

// timer
function startTimer(){ state.timerSec=0; tickTimer(); state.timerInterval=setInterval(tickTimer,1000); }
function stopTimer(){ if(state.timerInterval){clearInterval(state.timerInterval);state.timerInterval=null;} }
function tickTimer(){ state.timerSec++; document.getElementById('timerVal').textContent=fmtTime(state.timerSec); }
function fmtTime(s){ return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); }

// errors
function initErrors(){ state.errors={}; RAW.forEach((_,i)=>{ state.errors[i]={mainErrors:0,typeErrors:0,subErrors:[]}; RAW[i].subs.forEach(()=>state.errors[i].subErrors.push(0)); }); }
function recordError(idx,type,si){ const e=state.errors[idx]; if(!e)return; if(type==='main')e.mainErrors++; else if(type==='type')e.typeErrors++; else if(type==='sub')e.subErrors[si]++; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); }
function goHome(){
  stopTimer();
  closeOverlay();
  // reset é¦–é å…§éƒ¨ç‹€æ…‹ï¼Œç¢ºä¿å›ä¾†å¾Œçœ‹è¦‹é–‹å§‹æŒ‰éˆ•
  document.getElementById('startScreen').style.display='block';
  document.getElementById('midPickScreen').style.display='none';
  showPage('pageHome');
}
function goHistory(){ showPage('pageHistory'); renderHistory(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function chooseStart(mode){
  state.mode=mode;
  if(mode==='full') beginGame(0);
  else {
    document.getElementById('startScreen').style.display='none';
    document.getElementById('midPickScreen').style.display='block';
    document.getElementById('midPickList').innerHTML=RAW.map((item,i)=>
      `<div class="mid-pick-item" onclick="beginGame(${i})">
         <span class="mp-num">${i+1}</span>
         <div><div class="mp-name">${item.main}</div><div class="mp-name-en">${item.mainEn}</div></div>
       </div>`
    ).join('');
  }
}
function backToStart(){
  document.getElementById('midPickScreen').style.display='none';
  document.getElementById('startScreen').style.display='block';
}
function beginGame(fromIdx){
  state.startIdx=fromIdx; state.currentIdx=fromIdx;
  state.completedMains=[]; state.phase=null; state.subIdx=0;
  state.finished=false;
  initErrors();
  document.getElementById('startScreen').style.display='none';
  document.getElementById('midPickScreen').style.display='none';
  document.getElementById('finishBanner').style.display='none';
  document.getElementById('endBar').style.display='flex';
  document.getElementById('chain').innerHTML='';
  showPage('pageExam');
  updateProgress();
  rebuildChain();
  startTimer();
  setTimeout(()=>startNextMainQuiz(),350);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END EXAM (ä¸­æ–·)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function endExam(){
  closeOverlay();
  stopTimer();
  state.finished=false;
  saveRecord();
  document.getElementById('endBar').style.display='none';
  document.getElementById('chain').style.display='none';
  const fb=document.getElementById('finishBanner');
  document.getElementById('finishTitle').textContent='æ¸¬é©—ä¸­æ–·';
  document.getElementById('finishTime').textContent='ç”¨æ™‚ï¼š'+fmtTime(state.timerSec);
  document.getElementById('finishMode').textContent=(state.mode==='full'?'å®Œæ•´æ¸¬é©—':'å±€éƒ¨æ¸¬é©—')+' Â· ä¸­æ–·';
  fb.style.display='block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rebuildChain(){
  const chain=document.getElementById('chain');
  let html='';
  state.completedMains.forEach(idx=>{
    html+=renderDoneCard(idx)+`<div class="connector"><div class="connector-line"></div></div>`;
  });
  if(state.currentIdx<RAW.length && (state.phase==='selectType'||state.phase==='selectSub')){
    html+=renderActiveCard(state.currentIdx)+`<div class="connector"><div class="connector-line"></div></div>`;
  }
  chain.innerHTML=html;
  // æ²å‹•åˆ°ç•¶å‰æœ€å¾Œä¸€å¼µcardï¼ˆé…åˆæ”¶åˆå¾Œè§€çœ‹ï¼‰
  requestAnimationFrame(()=>{
    const lastCard=chain.querySelector('.card:last-of-type');
    if(lastCard) lastCard.scrollIntoView({behavior:'smooth', block:'center'});
  });
}

function renderDoneCard(idx){
  const it=RAW[idx];
  let sub='';
  if(it.type==='series') sub=`<div class="sub-items">`+it.subs.map(s=>`<div class="sub-item"><div class="dot"></div><span class="sub-name">${s.zh}<span class="sub-name-en">${s.en}</span></span></div>`).join('')+`</div>`;
  return `<div class="card"><div class="card-header">
    <div class="battery"><div class="battery-body"><div class="battery-fill" style="height:100%"></div></div><div class="battery-nub"></div></div>
    <div class="card-title"><div class="label">${it.type==='series'?'ç³»åˆ—å‹•ä½œ':'å–®ä¸€å‹•ä½œ'} Â· #${idx+1}</div><div class="name">${it.main}</div><div class="name-en">${it.mainEn}</div></div>
    <span class="card-status correct">å®Œæˆ</span></div>${sub}</div>`;
}
function renderActiveCard(idx){
  const it=RAW[idx];
  const pct=it.type==='series'?(state.subIdx/it.subs.length*100):0;
  let sub='';
  if(it.type==='series'&&state.subIdx>0) sub=`<div class="sub-items">`+it.subs.slice(0,state.subIdx).map(s=>`<div class="sub-item"><div class="dot"></div><span class="sub-name">${s.zh}<span class="sub-name-en">${s.en}</span></span></div>`).join('')+`</div>`;
  return `<div class="card"><div class="card-header">
    <div class="battery"><div class="battery-body"><div class="battery-fill" style="height:${pct}%"></div></div><div class="battery-nub"></div></div>
    <div class="card-title"><div class="label">${it.type==='series'?'ç³»åˆ—å‹•ä½œ':'å–®ä¸€å‹•ä½œ'} Â· #${idx+1}</div><div class="name">${it.main}</div><div class="name-en">${it.mainEn}</div></div>
    <span class="card-status pending">é€²è¡Œä¸­</span></div>${sub}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startNextMainQuiz(){ if(state.currentIdx>=RAW.length)return; state.phase='selectMain'; showMainQuiz(); openOverlay(); }

function showMainQuiz(){
  const idx=state.currentIdx, correct=RAW[idx];
  const wrongs=shuffle(RAW.filter((_,i)=>i!==idx)).slice(0,4);
  const options=shuffle([correct,...wrongs]);
  const isFirst=(idx===state.startIdx);
  const stepLabel=isFirst?'':'STEP 1 â€” é¸æ“‡ä¸‹ä¸€å€‹å‹•ä½œ';
  const question=isFirst?'ç¬¬ä¸€å€‹å‹•ä½œæ˜¯ï¼Ÿ':'æ¥ä¸‹ä¾†æ‡‰è©²æ˜¯å“ªå€‹å‹•ä½œï¼Ÿ';
  renderQuiz(stepLabel,question,
    options.map(o=>({zh:o.main,en:o.mainEn})), correct.main,
    (ok)=>{
      if(!ok){ recordError(idx,'main'); return; }
      state.phase='selectType'; rebuildChain();
      setTimeout(()=>{ showTypeQuiz(); openOverlay(); },420);
    }
  );
}

function showTypeQuiz(){
  const it=RAW[state.currentIdx];
  const correct=it.type==='series'?'ç³»åˆ—å‹•ä½œ':'å–®ä¸€å‹•ä½œ';
  renderQuiz('STEP 2 â€” åˆ¤æ–·å‹•ä½œé¡å‹',`ã€Œ${it.main}ã€æ˜¯å“ªç¨®é¡å‹ï¼Ÿ`,
    shuffle([{zh:'ç³»åˆ—å‹•ä½œ',en:'Series'},{zh:'å–®ä¸€å‹•ä½œ',en:'Single'}]), correct,
    (ok)=>{
      if(!ok){ recordError(state.currentIdx,'type'); return; }
      setTimeout(()=>{
        if(it.type==='single') finishCurrentItem();
        else { state.phase='selectSub'; state.subIdx=0; rebuildChain(); showSubQuiz(); openOverlay(); }
      },420);
    }
  );
}

function showSubQuiz(){
  const it=RAW[state.currentIdx], correctObj=it.subs[state.subIdx];
  // å¾åŒç³»åˆ—å…¶ä»–æ¬¡é …ç›®æŠ“ï¼ˆæœ€å¤š3å€‹ï¼‰
  const sameSubs=it.subs.filter((_,i)=>i!==state.subIdx);
  const innerPick=shuffle(sameSubs).slice(0,3);

  // å¦‚æœåŒå…§éƒ¨ä¸å¤ 3å€‹ï¼Œå¾å¤–é¢è£œåˆ°3å€‹
  let wrongs=[...innerPick];
  if(wrongs.length<3){
    const allOther=[]; RAW.forEach((r,ri)=>{ if(ri!==state.currentIdx) r.subs.forEach(s=>allOther.push(s)); });
    const pool=allOther.filter(s=>s.zh!==correctObj.zh && !wrongs.some(w=>w.zh===s.zh));
    wrongs.push(...shuffle(pool).slice(0, 3-wrongs.length));
  }

  // A-Dï¼šæ­£ç¢ºç­”æ¡ˆ + å‰3å€‹éŒ¯èª¤ï¼Œéš¨æ©Ÿæ’åˆ—
  // Eï¼šå›ºå®šç‚ºã€Œè©²ç³»åˆ—æ²’æœ‰å…¶ä»–å‹•ä½œäº†ã€
  const NONE_ITEM={zh:"è©²ç³»åˆ—æ²’æœ‰å…¶ä»–å‹•ä½œäº†", en:"No other moves in this series"};
  const firstFour=shuffle([correctObj,...wrongs.slice(0,3)]);
  const options=[...firstFour, NONE_ITEM];
  renderQuiz('',`ã€Œ${it.main}ã€çš„ç¬¬ ${state.subIdx+1} å€‹å‹•ä½œæ˜¯ï¼Ÿ`,
    options.map(o=>({zh:o.zh,en:o.en})), correctObj.zh,
    (ok)=>{
      if(!ok){ recordError(state.currentIdx,'sub',state.subIdx); return; }
      state.subIdx++; rebuildChain();
      setTimeout(()=>{
        if(state.subIdx>=it.subs.length) finishCurrentItem();
        else { showSubQuiz(); openOverlay(); }
      },420);
    }
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ RENDER
// renderQuizï¼šç”Ÿæˆé¸é …ä¸¦æ¸²æŸ“ï¼ˆæ–°é¡Œæ™‚èª¿ç”¨ï¼‰
// resetQuizUIï¼šéŒ¯èª¤å¾Œåªæ¸…æ‰ç´…è‰²æ¨™è¨˜ï¼Œæ¢å¾©å¯é»æ“Šï¼Œé¸é …å…§å®¹ä¸è®Š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQuiz(stepLabel,question,options,correctZh,onDone){
  document.getElementById('quizStepLabel').textContent=stepLabel;
  document.getElementById('quizQuestion').textContent=question;
  const keys=['A','B','C','D','E'];
  document.getElementById('quizOptions').innerHTML=options.map((o,i)=>
    `<div class="option" id="opt-${i}" onclick="pickOption(${i})">
       <div class="opt-key">${keys[i]}</div>
       <div class="opt-label">${o.zh} <span class="opt-en">| ${o.en}</span></div>
     </div>`
  ).join('');
  document.getElementById('quizFeedback').className='feedback';
  document.getElementById('quizFeedback').innerHTML='';
  window._quiz={options,correctZh,onDone,locked:false};
}

function resetQuizUI(){
  // åªæ¸…æ‰ç´…è‰²æ¨™è¨˜å’Œåé¥‹ï¼Œé¸é …å…§å®¹ä¸å‹•ï¼Œæ¢å¾©å¯é»æ“Š
  document.querySelectorAll('.option').forEach(el=>{
    el.classList.remove('wrong-pick','correct-pick','disabled');
  });
  document.getElementById('quizFeedback').className='feedback';
  document.getElementById('quizFeedback').innerHTML='';
  if(window._quiz) window._quiz.locked=false;
}

function pickOption(idx){
  const q=window._quiz;
  if(!q||q.locked) return;
  q.locked=true;
  const chosen=q.options[idx].zh;
  const ok=(chosen===q.correctZh);
  const fb=document.getElementById('quizFeedback');
  const el=document.getElementById('opt-'+idx);

  if(ok){
    el.classList.add('correct-pick');
    fb.innerHTML='<span class="f-icon">âœ“</span> æ­£ç¢ºï¼';
    fb.className='feedback show';
    // æ­£ç¢ºï¼šé–ƒç¶  â†’ é—œé–‰ overlay â†’ é€²ä¸‹ä¸€æ­¥
    setTimeout(()=>{ closeOverlay(); setTimeout(()=>q.onDone(true),80); },400);
  } else {
    // éŒ¯èª¤ï¼šé–ƒç´… + è¨Šæ¯ï¼Œç¶­æŒ1ç§’ï¼Œç„¶å¾Œåªé‡ç½®UIï¼ˆé¸é …ä¸è®Šï¼‰
    el.classList.add('wrong-pick');
    fb.innerHTML='<span class="f-icon">âœ—</span> å†è©¦ä¸€æ¬¡ï¼';
    fb.className='feedback show';
    setTimeout(()=>{
      q.onDone(false);   // è¨˜éŒ„éŒ¯èª¤
      resetQuizUI();     // æ¸…æ‰ç´…è‰²ï¼Œæ¢å¾©é»æ“Šï¼Œé¸é …å…§å®¹ä¸å‹•
    },1000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINISH (å®Œæˆå…¨éƒ¨)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function finishCurrentItem(){
  state.completedMains.push(state.currentIdx);
  state.currentIdx++; state.phase=null; state.subIdx=0;
  updateProgress(); rebuildChain();

  if(state.currentIdx>=RAW.length){
    stopTimer();
    state.finished=true;
    saveRecord();
    document.getElementById('endBar').style.display='none';
    document.getElementById('chain').style.display='none';
    const fb=document.getElementById('finishBanner');
    document.getElementById('finishTitle').textContent='ğŸ‰ å®Œæˆï¼';
    document.getElementById('finishTime').textContent='å®Œæˆæ™‚é–“ï¼š'+fmtTime(state.timerSec);
    document.getElementById('finishMode').textContent=(state.mode==='full'?'å®Œæ•´æ¸¬é©—':'å±€éƒ¨æ¸¬é©—')+' Â· å®Œæˆ';
    fb.style.display='block';
  } else {
    setTimeout(()=>startNextMainQuiz(),450);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERLAY + æ”¶åˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openOverlay(){
  const ov=document.getElementById('overlay');
  // å…ˆæ²å‹•åˆ°ç•¶å‰ä½ç½®ï¼Œè®“æ”¶åˆå¾Œçœ‹è¦‹æ­£ç¢ºä½ç½®ï¼ˆ3.4ï¼‰
  const chain=document.getElementById('chain');
  const lastCard=chain.querySelector('.card:last-of-type');
  if(lastCard){
    lastCard.scrollIntoView({behavior:'smooth', block:'center'});
  }
  ov.classList.remove('collapsed');
  ov.classList.add('open');
}
function closeOverlay(){
  const ov=document.getElementById('overlay');
  ov.classList.remove('open','collapsed');
}
function toggleCollapse(){
  const ov=document.getElementById('overlay');
  if(ov.classList.contains('collapsed')){
    // å±•é–‹å›ä¾†
    ov.classList.remove('collapsed');
    ov.classList.add('open');
  } else {
    // æ”¶åˆï¼šé®å…‰æ¶ˆå¤±ï¼Œpanelç¸®ç‚ºå°æ¢ï¼Œè§¸æ‘¸ç©¿é€èƒŒå¾Œ
    ov.classList.remove('open');
    ov.classList.add('collapsed');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SKEY='pilates_history';
function loadHistory(){ try{return JSON.parse(localStorage.getItem(SKEY))||[];}catch(e){return[];} }
function saveHistory(a){ localStorage.setItem(SKEY,JSON.stringify(a)); }

function saveRecord(){
  const h=loadHistory();
  const now=new Date();
  h.push({
    date:now.getFullYear()+'/'+String(now.getMonth()+1).padStart(2,'0')+'/'+String(now.getDate()).padStart(2,'0'),
    time:String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0'),
    mode:state.mode,
    startIdx:state.startIdx,
    finished:state.finished,
    duration:state.timerSec,
    errors:JSON.parse(JSON.stringify(state.errors))
  });
  saveHistory(h);
}

function renderHistory(){
  const history=loadHistory();

  // â”€â”€â”€ æ¸¬é©—è¨˜éŒ„ â”€â”€â”€
  const rList=document.getElementById('recordsList');
  if(!history.length){ rList.innerHTML=`<div class="empty-msg">æ²’æœ‰æ¸¬é©—è¨˜éŒ„</div>`; }
  else {
    const reversed=[...history].reverse();
    const SHOW_LIMIT=5;
    const allHtml=reversed.map(r=>{
      const modeClass=r.mode==='full'?'full':'partial';
      const modeLabel=r.mode==='full'?'å®Œæ•´æ¸¬é©—':'å±€éƒ¨æ¸¬é©—';
      const statusClass=r.finished?'complete':'interrupted';
      const statusLabel=r.finished?'å®Œæˆ':'ä¸­æ–·';
      return `<div class="record-item">
        <div class="record-date">${r.date} ${r.time}</div>
        <div class="record-badges">
          <span class="record-badge ${modeClass}">${modeLabel}</span>
          <span class="record-badge ${statusClass}">${statusLabel}</span>
        </div>
      </div>`;
    });
    if(reversed.length<=SHOW_LIMIT){
      rList.innerHTML=allHtml.join('');
    } else {
      const firstPart=allHtml.slice(0,SHOW_LIMIT).join('');
      const restPart=allHtml.slice(SHOW_LIMIT).join('');
      rList.innerHTML=firstPart
        +`<div id="recordsMore" style="display:none">${restPart}</div>`
        +`<button class="more-btn" onclick="toggleRecords()">æ›´å¤šç´€éŒ„... (${reversed.length-SHOW_LIMIT})</button>`;
    }
  }

  // â”€â”€â”€ æ•¸æ“šåˆ†æ â”€â”€â”€
  const totalErr={}, totalAtt={};
  RAW.forEach((_,i)=>{ totalErr[i]={main:0,type:0,sub:[]}; totalAtt[i]={main:0,type:0,sub:[]}; RAW[i].subs.forEach(()=>{ totalErr[i].sub.push(0); totalAtt[i].sub.push(0); }); });

  history.forEach(r=>{
    if(!r.errors)return;
    Object.keys(r.errors).forEach(k=>{
      const idx=parseInt(k), e=r.errors[k];
      if(!totalErr[idx])return;
      totalErr[idx].main+=(e.mainErrors||0); totalAtt[idx].main+=1;
      totalErr[idx].type+=(e.typeErrors||0); totalAtt[idx].type+=1;
      if(e.subErrors) e.subErrors.forEach((c,si)=>{
        if(totalErr[idx].sub[si]!==undefined){ totalErr[idx].sub[si]+=c; totalAtt[idx].sub[si]+=1; }
      });
    });
  });

  const aList=document.getElementById('analysisList');
  if(!history.length){ aList.innerHTML=`<div class="empty-msg">æ²’æœ‰æ•¸æ“š</div>`; }
  else {
    aList.innerHTML=RAW.map((item,idx)=>{
      const e=totalErr[idx], a=totalAtt[idx];
      let tErr=e.main+e.type, tAtt=a.main+a.type;
      e.sub.forEach((c,si)=>{ tErr+=c; tAtt+=a.sub[si]; });
      const rate=tAtt>0?Math.round(tErr/tAtt*100):0;
      const cls=rate===0?'zero':(rate<=30?'low':'high');

      let subsHtml='';
      if(item.type==='series'){
        subsHtml=`<div class="analysis-sub">`+item.subs.map((s,si)=>{
          const sE=totalErr[idx].sub[si], sA=totalAtt[idx].sub[si];
          const sR=sA>0?Math.round(sE/sA*100):0;
          const sC=sR===0?'zero':(sR<=30?'low':'high');
          return `<div class="analysis-item">
            <div class="a-battery" style="width:20px;height:12px">
              <div class="a-bat-body" style="width:17px;height:12px"><div class="a-bat-fill" style="height:${100-sR}%"></div></div>
              <div class="a-bat-nub" style="width:2px;height:5px"></div>
            </div>
            <div class="a-info"><div class="a-name" style="font-size:.72rem">${s.zh}</div><div class="a-name-en" style="font-size:.6rem">${s.en}</div></div>
            <div class="a-err ${sC}">${sR}%</div>
          </div>`;
        }).join('')+`</div>`;
      }

      return `<div class="analysis-item">
        <div class="a-battery">
          <div class="a-bat-body"><div class="a-bat-fill" style="height:${100-rate}%"></div></div>
          <div class="a-bat-nub"></div>
        </div>
        <div class="a-info"><div class="a-name">${item.main}</div><div class="a-name-en">${item.mainEn}</div></div>
        <div class="a-err ${cls}">${rate}%</div>
      </div>${subsHtml}`;
    }).join('');
  }
}

function toggleRecords(){
  const more=document.getElementById('recordsMore');
  const btn=document.querySelector('.more-btn');
  if(!more||!btn) return;
  const isOpen=(more.style.display==='block');
  more.style.display=isOpen?'none':'block';
  btn.textContent=isOpen?'æ›´å¤šç´€éŒ„... ('+more.querySelectorAll('.record-item').length+')':'æ”¶èµ·';
}

function clearHistory(){ localStorage.removeItem(SKEY); renderHistory(); }
</script>
</body>
</html>
